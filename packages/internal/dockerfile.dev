FROM node:22-alpine AS base
RUN apk update && apk add --no-cache libc6-compat
RUN corepack enable


FROM base AS builder 
WORKDIR /usr/src/app
COPY . .
RUN yarn dlx turbo prune internal --out-dir dist --docker

FROM base AS installer
WORKDIR /usr/src/app
COPY --from=builder /usr/src/app/dist/json/ .
RUN yarn install
COPY --from=builder /usr/src/app/dist/full/ .
RUN yarn build

CMD ["node", "packages/internal/dist/main.js"]
